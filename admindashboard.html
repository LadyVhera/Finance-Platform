<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TPT M√©xico ‚Äî Admin Dashboard</title>
    <meta name="description" content="Admin: moderation, KYC, members, ledger, tickets, policies, roles, and audit." />
    <!-- Fonts & CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg: #071026;
            --card: #0f1730;
            --ink: #e6eef8;
            --muted: #9fb0c9;
            --accent1: #00e0ff;
            --accent2: #0072ff;
            --btn-text: #021023;
            --sidebar: #0c142b;
            --radius: 16px;
        }

        html,
        body {
            height: 100%;
            background: var(--bg);
            color: var(--ink);
            font-family: Inter, -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial;
            -webkit-font-smoothing: antialiased
        }

        a {
            text-decoration: none
        }

        .btn {
            border: none;
            font-weight: 700;
            border-radius: 12px;
            transition: transform .18s ease, box-shadow .28s ease, filter .2s ease, background .28s ease, color .28s ease
        }

        .btn,
        .btn-primary,
        .btn-success,
        .btn-danger,
        .btn-warning,
        .btn-info {
            background: linear-gradient(90deg, var(--accent2), var(--accent1));
            color: var(--btn-text);
            box-shadow: 0 6px 20px rgba(0, 112, 255, .12)
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 224, 255, .18)
        }

        .btn-outline-light {
            background: transparent !important;
            color: #e6f0ff !important;
            border: 1px solid rgba(255, 255, 255, .18) !important;
            box-shadow: none !important
        }

        .btn-outline-light:hover {
            background: linear-gradient(90deg, var(--accent2), var(--accent1)) !important;
            color: var(--btn-text) !important;
            border-color: transparent !important;
            box-shadow: 0 12px 40px rgba(0, 224, 255, .18) !important
        }

        .badge-soft {
            background: black;
            color: #bff3ff;
            border: 1px solid rgba(102, 224, 255, .25)
        }

        .cardx {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 14px;
            transition: transform .18s ease, box-shadow .28s ease
        }

        .cardx:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 48px rgba(1, 9, 26, .6)
        }

        .muted {
            color: var(--muted)
        }

        .layout {
            display: grid;
            grid-template-columns: 270px 1fr;
            min-height: 100vh
        }

        .sidebar {
            background: var(--sidebar);
            border-right: 1px solid rgba(255, 255, 255, .06);
            position: sticky;
            top: 0;
            height: 100vh;
            padding: 14px;
            overflow: auto
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px 8px
        }

        .brand .logo {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: grid;
            place-items: center;
            background: linear-gradient(90deg, var(--accent2), var(--accent1));
            color: #fff;
            font-weight: 800
        }

        .nav-link {
            color: #cbd5e1;
            border-radius: 10px;
            padding: 10px 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, .06);
            color: #fff
        }

        .nav-link.active {
            background: linear-gradient(90deg, rgba(0, 114, 255, .18), rgba(0, 224, 255, .18));
            color: #fff;
            border: 1px solid rgba(0, 224, 255, .18);
            text-shadow: 0 0 10px rgba(0, 224, 255, .35)
        }

        .content {
            padding: 16px
        }

        .topbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: rgba(12, 18, 36, .6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, .06);
            padding: 10px 16px;
            border-radius: 14px
        }

        .table-dark {
            --bs-table-bg: #0e1731;
            --bs-table-striped-bg: #111d3b;
            --bs-table-hover-bg: #0f1a35
        }

        .form-control,
        .form-select {
            background: #0c1328;
            color: var(--ink);
            border: 1px solid rgba(255, 255, 255, .12)
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--accent1);
            box-shadow: 0 0 0 .16rem rgba(0, 224, 255, .15)
        }

        .kpi {
            display: flex;
            gap: 14px;
            align-items: center
        }

        .kpi .stat {
            font-size: clamp(1.5rem, 3vw, 2.2rem);
            font-weight: 800
        }

        .progress {
            background: rgba(255, 255, 255, .06);
            height: 8px;
            border-radius: 999px
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--accent2), var(--accent1))
        }

        .alert-note {
            border: 1px dashed rgba(255, 255, 255, .2);
            background: rgba(0, 224, 255, .05)
        }

        .pill {
            font-size: .75rem;
            border: 1px solid rgba(255, 255, 255, .15);
            border-radius: 999px;
            padding: .15rem .5rem
        }

        @media (max-width: 991.98px) {
            .layout {
                grid-template-columns: 1fr
            }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 0;
                height: 100vh;
                width: 280px;
                z-index: 1050;
                transition: left .25s ease
            }

            .sidebar.open {
                left: 0
            }

            .content {
                padding: 10px
            }

            .topbar {
                border-radius: 10px
            }
        }
    </style>
</head>

<body>

    <script>
        if (localStorage.getItem("isAdmin") !== "true") {
            window.location.href = "./"; // or your user dashboard
        }
    </script>

    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="brand mb-2">
                <div class="logo">ADM</div>
                <div>
                    <div class="fw-bold">TPT Admin</div>
                    <small class="muted">Moderation & Oversight</small>
                </div>
            </div>

            <nav class="nav nav-pills flex-column gap-1" role="tablist">
                <a class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-overview"><i
                        class="bi bi-speedometer2"></i> Overview</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-queue"><i class="bi bi-inboxes"></i>
                    Requests Queue</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-kyc"><i class="bi bi-shield-check"></i>
                    KYC Review</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-members"><i class="bi bi-people"></i>
                    Members</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ledger"><i class="bi bi-wallet2"></i>
                    Ledger & Reports</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-tickets"><i class="bi bi-chat-dots"></i>
                    Tickets</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-policies"><i class="bi bi-file-text"></i>
                    Policies CMS</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings"><i class="bi bi-gear"></i>
                    Settings & Roles</a>
                <a class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-audit"><i
                        class="bi bi-clipboard-check"></i> Audit Log</a>
            </nav>

            <div class="mt-3 small muted">
                <div class="fw-semibold mb-1">Quick actions</div>
                <div class="d-grid gap-2">
                    <button class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#modalBroadcast"><i
                            class="bi bi-megaphone me-1"></i>Broadcast</button>
                    <button class="btn btn-sm btn-outline-light" id="btnExportAll"><i
                            class="bi bi-download me-1"></i>Export CSVs</button>
                </div>
            </div>

            <div class="mt-4">
                <div class="small muted">¬© <span id="year"></span> TPT M√©xico</div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="content">
            <!-- TOPBAR -->
            <div class="topbar d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-light btn-sm d-lg-none" id="btnToggleSidebar"><i
                            class="bi bi-list"></i></button>
                    <div class="fw-semibold">Welcome, <span id="adminNameTop">Administrator</span> üîê</div>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <span class="badge-soft px-2 py-1 small" id="roleBadge">Role: Super Admin</span>
                    <img class="avatar"
                        src="https://images.unsplash.com/photo-1607746882042-944635dfe10e?q=80&w=160&auto=format&fit=crop"
                        alt="admin"
                        style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.18)">
                </div>
            </div>

            <div class="tab-content">
                <!-- OVERVIEW -->
                <section class="tab-pane fade show active" id="tab-overview">
                    <div class="row g-3">
                        <div class="col-xl-3 col-md-6">
                            <div class="cardx p-3 h-100">
                                <div class="kpi">
                                    <i class="bi bi-people fs-3 text-info"></i>
                                    <div>
                                        <div class="stat" id="kpiMembers">0</div>
                                        <div class="muted small">Total Members</div>
                                    </div>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="pbMembers" style="width:0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="cardx p-3 h-100">
                                <div class="kpi">
                                    <i class="bi bi-inboxes fs-3 text-warning"></i>
                                    <div>
                                        <div class="stat" id="kpiPendingReq">0</div>
                                        <div class="muted small">Requests Pending</div>
                                    </div>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="pbReq" style="width:0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="cardx p-3 h-100">
                                <div class="kpi">
                                    <i class="bi bi-shield-check fs-3 text-success"></i>
                                    <div>
                                        <div class="stat" id="kpiKyc">0</div>
                                        <div class="muted small">KYC Pending</div>
                                    </div>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="pbKyc" style="width:0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-md-6">
                            <div class="cardx p-3 h-100">
                                <div class="kpi">
                                    <i class="bi bi-cash-coin fs-3 text-danger"></i>
                                    <div>
                                        <div class="stat" id="kpiVolume">‚Ç±0</div>
                                        <div class="muted small">30-day Volume</div>
                                    </div>
                                </div>
                                <div class="progress mt-3">
                                    <div class="progress-bar" id="pbVol" style="width:0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mt-1">
                        <div class="col-lg-8">
                            <div class="cardx p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="m-0">Activity (30 days)</h6>
                                    <span class="badge-soft px-2 py-1 small">Admin view</span>
                                </div>
                                <canvas id="chartAdminActivity" height="120"></canvas>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="cardx p-3 h-100">
                                <h6 class="mb-2">Category Split</h6>
                                <canvas id="chartAdminSplit" height="120"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="cardx p-3 mt-2">
                        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                            <div class="muted small"><i class="bi bi-shield-exclamation me-1"></i>Reminder: TPT is a
                                mutual-aid community, <strong>not</strong> an investment. Keep public copy free of
                                ‚Äúreturns/percent‚Äù claims. Legacy items must be marked <em>illustrative</em>.</div>
                            <button class="btn btn-sm btn-outline-light" data-bs-toggle="tab"
                                data-bs-target="#tab-policies"><i class="bi bi-file-text me-1"></i>Open Policies
                                CMS</button>
                        </div>
                    </div>
                </section>

                <!-- REQUESTS QUEUE -->
                <section class="tab-pane fade" id="tab-queue">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">Requests Moderation Queue</h5>
                        <div class="d-flex gap-2">
                            <input class="form-control form-control-sm" id="qSearch" placeholder="Search ref/title‚Ä¶">
                            <select class="form-select form-select-sm" id="qFilter">
                                <option value="">All</option>
                                <option selected>Pending</option>
                                <option>Verified</option>
                                <option>Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive cardx p-3">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Ref</th>
                                    <th>Title</th>
                                    <th>Member</th>
                                    <th>Category</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tblQueue"></tbody>
                        </table>
                    </div>
                    <div class="small muted mt-2"><span class="pill">Policy</span> Approve only with adequate proof &
                        consistent bank details. Rejections must include a note.</div>
                </section>

                <!-- KYC REVIEW -->
                <section class="tab-pane fade" id="tab-kyc">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">KYC Review</h5>
                        <div class="d-flex gap-2">
                            <input class="form-control form-control-sm" id="kycSearch" placeholder="Search name/email‚Ä¶">
                            <select class="form-select form-select-sm" id="kycFilter">
                                <option value="">All</option>
                                <option selected>Pending</option>
                                <option>Approved</option>
                                <option>Rejected</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-responsive cardx p-3">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Submitted</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tblKyc"></tbody>
                        </table>
                    </div>
                    <div class="alert alert-note small muted mt-2"><i class="bi bi-info-circle me-1"></i>Store only
                        what‚Äôs necessary. Purge expired KYC data on schedule.</div>
                </section>

                <!-- MEMBERS -->
                <section class="tab-pane fade" id="tab-members">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">Members</h5>
                        <div class="d-flex gap-2">
                            <input class="form-control form-control-sm" id="mSearch" placeholder="Search name/email‚Ä¶">
                            <select class="form-select form-select-sm" id="mFilter">
                                <option value="">All</option>
                                <option>Active</option>
                                <option>Pending</option>
                                <option>Suspended</option>
                            </select>
                            <button class="btn btn-sm btn-outline-light" id="btnAddMember"><i
                                    class="bi bi-person-plus me-1"></i>Add</button>
                        </div>
                    </div>
                    <div class="table-responsive cardx p-3">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Status</th>
                                    <th>Requests</th>
                                    <th>Provided</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tblMembers"></tbody>
                        </table>
                    </div>
                </section>

                <!-- LEDGER & REPORTS -->
                <section class="tab-pane fade" id="tab-ledger">
                    <div class="row g-3">
                        <div class="col-lg-4">
                            <div class="cardx p-3 h-100">
                                <h6>Summary</h6>
                                <div class="mt-2 d-grid gap-1">
                                    <div class="d-flex justify-content-between"><span class="muted">Total
                                            Provided</span><strong id="sumProvided">‚Ç±0</strong></div>
                                    <div class="d-flex justify-content-between"><span class="muted">Total
                                            Received</span><strong id="sumReceived">‚Ç±0</strong></div>
                                    <div class="d-flex justify-content-between"><span class="muted">Net</span><strong
                                            id="sumNet">‚Ç±0</strong></div>
                                </div>
                                <canvas id="chartLedger" height="90" class="mt-3"></canvas>
                                <button class="btn btn-sm mt-3" id="btnExportTx"><i
                                        class="bi bi-download me-1"></i>Export Transactions</button>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="cardx p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="m-0">Transactions</h6>
                                    <input class="form-control form-control-sm" id="txSearch"
                                        placeholder="Search ref/type/member‚Ä¶">
                                </div>
                                <div class="table-responsive mt-2">
                                    <table class="table table-dark table-striped table-hover align-middle">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Ref</th>
                                                <th>Amount</th>
                                                <th>Member</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tblTx"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- TICKETS -->
                <section class="tab-pane fade" id="tab-tickets">
                    <div class="row g-3">
                        <div class="col-lg-4">
                            <div class="cardx p-3 h-100">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <h6 class="m-0">Tickets</h6>
                                    <button class="btn btn-sm btn-outline-light" id="btnNewTicket"><i
                                            class="bi bi-pencil-square me-1"></i>New</button>
                                </div>
                                <div class="list-group list-group-flush" id="tktList"
                                    style="--bs-list-group-color:#cbd5e1;--bs-list-group-bg:transparent;--bs-list-group-border-color:rgba(255,255,255,.06)">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="cardx p-3 h-100">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h6 class="m-0" id="tktTitle">Select a ticket</h6>
                                    <div class="muted small" id="tktMeta"></div>
                                </div>
                                <hr>
                                <div id="tktThread" class="d-flex flex-column gap-2"
                                    style="height:280px;overflow:auto;"></div>
                                <form class="mt-2 d-flex gap-2" id="formReply">
                                    <input class="form-control" placeholder="Reply‚Ä¶" id="tktInput" />
                                    <button class="btn" type="submit"><i class="bi bi-send"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- POLICIES CMS -->
                <section class="tab-pane fade" id="tab-policies">
                    <div class="cardx p-3">
                        <h5 class="mb-2">Policies & Copy Manager</h5>
                        <p class="muted small mb-2">Keep public content aligned with ‚Äúmutual-aid, not investment.‚Äù
                            Legacy items (e.g., FELICIDAD/bonuses) must be labeled <em>illustrative</em> or removed.</p>
                        <form class="row g-2" id="formCms">
                            <div class="col-12"><label class="form-label small">About / Ideology</label><textarea
                                    class="form-control" rows="4" id="cmsAbout"></textarea></div>
                            <div class="col-12"><label class="form-label small">Risks & Legality</label><textarea
                                    class="form-control" rows="3" id="cmsRisk"></textarea></div>
                            <div class="col-12"><label class="form-label small">FAQ</label><textarea
                                    class="form-control" rows="3" id="cmsFaq"></textarea></div>
                            <div class="col-12 d-flex gap-2">
                                <button class="btn btn-sm" type="submit"><i class="bi bi-save me-1"></i>Save</button>
                                <button class="btn btn-sm btn-outline-light" type="button" id="btnPreviewPolicy"><i
                                        class="bi bi-eye me-1"></i>Preview</button>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- SETTINGS & ROLES -->
                <section class="tab-pane fade" id="tab-settings">
                    <div class="row g-3">
                        <div class="col-lg-6">
                            <div class="cardx p-3 h-100">
                                <h6>Admin Preferences</h6>
                                <form id="formPrefs" class="mt-2">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="prefEmail" checked>
                                        <label class="form-check-label" for="prefEmail">Email alerts</label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="prefSound">
                                        <label class="form-check-label" for="prefSound">Sound on ticket</label>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">Language</label>
                                        <select class="form-select" id="prefLang">
                                            <option>English</option>
                                            <option selected>Espa√±ol</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-sm mt-2" type="submit">Save</button>
                                </form>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="cardx p-3 h-100">
                                <h6>Roles & Access</h6>
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped align-middle">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Role</th>
                                                <th class="text-end">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tblRoles"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AUDIT LOG -->
                <section class="tab-pane fade" id="tab-audit">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="m-0">Audit Log</h5>
                        <button class="btn btn-sm btn-outline-light" id="btnExportAudit"><i
                                class="bi bi-download me-1"></i>Export</button>
                    </div>
                    <div class="table-responsive cardx p-3">
                        <table class="table table-dark table-striped table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>When</th>
                                    <th>Admin</th>
                                    <th>Action</th>
                                    <th>Target</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="tblAudit"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal fade" id="modalBroadcast" tabindex="-1">
        <div class="modal-dialog modal-md modal-dialog-centered">
            <div class="modal-content"
                style="background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.10)">
                <div class="modal-header border-0">
                    <h6 class="modal-title"><i class="bi bi-megaphone me-1"></i>Broadcast Message</h6>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formBroadcast">
                        <div class="mb-2"><label class="form-label small">Audience</label>
                            <select class="form-select" id="bcAudience">
                                <option>All Members</option>
                                <option>Verified Only</option>
                                <option>Pending KYC</option>
                            </select>
                        </div>
                        <div class="mb-2"><label class="form-label small">Message</label><textarea class="form-control"
                                id="bcMsg" rows="3" required></textarea></div>
                        <button class="btn btn-sm" type="submit">Send Broadcast</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>

       
  // simple front-end gate; replace with server auth in production
                if (localStorage.getItem("isAdmin") !== "true") {
                    window.location.href = "./"; // or wherever your user dashboard/login is
  }
        

        // ---------- Utilities ----------
        const fmt = v => '‚Ç±' + Number(v).toLocaleString();
        const uid = p => p + Math.random().toString(36).slice(2, 7).toUpperCase();
        const nowISO = () => new Date().toISOString().slice(0, 19).replace('T', ' ');
        document.getElementById('year').textContent = new Date().getFullYear();
        const sidebar = document.getElementById('sidebar');
        document.getElementById('btnToggleSidebar')?.addEventListener('click', () => sidebar.classList.toggle('open'));

        // ---------- Admin localStorage keys ----------
        const ALS = {
            MEMBERS: 'tpt_admin_members',
            REQS: 'tpt_admin_requests',
            KYC: 'tpt_admin_kyc',
            TX: 'tpt_admin_tx',
            TICKETS: 'tpt_admin_tickets',
            ROLES: 'tpt_admin_roles',
            AUDIT: 'tpt_admin_audit',
            CMS: 'tpt_admin_cms'
        };

        // ---------- Seed Demo Data ----------
        (function seed() {
            if (!localStorage.getItem(ALS.MEMBERS)) {
                localStorage.setItem(ALS.MEMBERS, JSON.stringify([
                    { id: 'U-101', name: 'Ana L√≥pez', email: 'ana@example.com', joined: '2025-09-21', status: 'Active', reqs: 2, provided: 1 },
                    { id: 'U-102', name: 'Jos√© P√©rez', email: 'jose@example.com', joined: '2025-10-01', status: 'Pending', reqs: 1, provided: 0 },
                    { id: 'U-103', name: 'Marcus Montes', email: 'marcus@example.com', joined: '2025-09-12', status: 'Active', reqs: 0, provided: 2 }
                ]));
            }
            if (!localStorage.getItem(ALS.REQS)) {
                localStorage.setItem(ALS.REQS, JSON.stringify([
                    { id: 'R-1201', title: 'Emergency rent', member: 'Ana L√≥pez', cat: 'Housing', amount: 9000, status: 'Pending', created: '2025-10-04' },
                    { id: 'R-1202', title: 'Medication fund', member: 'Jos√© P√©rez', cat: 'Medical', amount: 6000, status: 'Pending', created: '2025-10-08' },
                    { id: 'R-1203', title: 'Tuition & books', member: 'Marcus Montes', cat: 'Education', amount: 12000, status: 'Verified', created: '2025-10-10' }
                ]));
            }
            if (!localStorage.getItem(ALS.KYC)) {
                localStorage.setItem(ALS.KYC, JSON.stringify([
                    { id: 'K-2001', name: 'Ana L√≥pez', email: 'ana@example.com', submitted: '2025-10-03', status: 'Pending', notes: '' },
                    { id: 'K-2002', name: 'Jos√© P√©rez', email: 'jose@example.com', submitted: '2025-10-08', status: 'Pending', notes: '' }
                ]));
            }
            if (!localStorage.getItem(ALS.TX)) {
                localStorage.setItem(ALS.TX, JSON.stringify([
                    { date: '2025-10-12', type: 'Received', ref: 'R-1203', amount: 12000, member: 'Marcus Montes', status: 'Completed' },
                    { date: '2025-10-13', type: 'Provided', ref: 'R-9932', amount: 5000, member: 'Ana L√≥pez', status: 'Completed' },
                    { date: '2025-10-14', type: 'Provided', ref: 'R-1201', amount: 9000, member: '(payer hidden)', status: 'Completed' }
                ]));
            }
            if (!localStorage.getItem(ALS.TICKETS)) {
                localStorage.setItem(ALS.TICKETS, JSON.stringify([
                    { id: 'T-1', title: 'Verification help', from: 'Ana L√≥pez', last: '2025-10-13', thread: [{ me: false, text: 'Hi, ID uploaded. Anything else?', at: '2025-10-13 10:04' }, { me: true, text: 'Thanks. Please add a selfie.', at: '2025-10-13 10:10' }] },
                    { id: 'T-2', title: 'Proof of transfer', from: 'Marcus Montes', last: '2025-10-14', thread: [{ me: false, text: 'Sent ‚Ç±6,000 for R-1201. Receipt attached.', at: '2025-10-14 07:20' }, { me: true, text: 'Confirmed, thank you!', at: '2025-10-14 07:35' }] }
                ]));
            }
            if (!localStorage.getItem(ALS.ROLES)) {
                localStorage.setItem(ALS.ROLES, JSON.stringify([
                    { user: 'admin@tpt.mx', role: 'Super Admin' },
                    { user: 'reviewer@tpt.mx', role: 'Reviewer' },
                    { user: 'support@tpt.mx', role: 'Support' }
                ]));
            }
            if (!localStorage.getItem(ALS.AUDIT)) {
                localStorage.setItem(ALS.AUDIT, JSON.stringify([
                    { at: '2025-10-14 08:12', admin: 'admin@tpt.mx', action: 'VERIFY_REQUEST', target: 'R-1203', notes: 'Docs matched' },
                    { at: '2025-10-14 08:30', admin: 'support@tpt.mx', action: 'REPLY_TICKET', target: 'T-2', notes: 'Receipt confirmed' }
                ]));
            }
            if (!localStorage.getItem(ALS.CMS)) {
                localStorage.setItem(ALS.CMS, JSON.stringify({
                    about: 'TPT is a voluntary mutual-aid community ‚Äî not an investment product.',
                    risk: 'Participation involves risk. Contributions are gifts; no guaranteed returns. Follow your country‚Äôs laws.',
                    faq: 'Q: Is this an investment?\nA: No. It is mutual aid with documented verification.'
                }));
            }
        })();

        // ---------- Helpers ----------
        function exportCsv(name, headers, rows) {
            const csv = [headers, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = name;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function audit(action, target, notes) {
            const arr = JSON.parse(localStorage.getItem(ALS.AUDIT) || '[]');
            const roles = JSON.parse(localStorage.getItem(ALS.ROLES) || '[]');
            const me = (roles.find(r => r.role === 'Super Admin') || { user: 'admin@tpt.mx' }).user;
            arr.unshift({ at: nowISO(), admin: me, action, target, notes: notes || '' });
            localStorage.setItem(ALS.AUDIT, JSON.stringify(arr));
            paintAudit();
        }

        // ---------- Overview KPIs & Charts ----------
        function refreshOverview() {
            const members = JSON.parse(localStorage.getItem(ALS.MEMBERS) || '[]');
            const reqs = JSON.parse(localStorage.getItem(ALS.REQS) || '[]');
            const kyc = JSON.parse(localStorage.getItem(ALS.KYC) || '[]');
            const tx = JSON.parse(localStorage.getItem(ALS.TX) || '[]');

            const kMembers = members.length;
            const kPendingReq = reqs.filter(r => r.status === 'Pending').length;
            const kKyc = kyc.filter(k => k.status === 'Pending').length;
            const vol30 = tx.reduce((a, b) => a + (b.type === 'Provided' || b.type === 'Received' ? b.amount : 0), 0);

            kpiMembers.textContent = kMembers;
            kpiPendingReq.textContent = kPendingReq;
            kpiKyc.textContent = kKyc;
            kpiVolume.textContent = fmt(vol30);

            pbMembers.style.width = Math.min(100, kMembers % 100) + '%';
            pbReq.style.width = Math.min(100, kPendingReq * 10) + '%';
            pbKyc.style.width = Math.min(100, kKyc * 10) + '%';
            pbVol.style.width = Math.min(100, vol30 % 100) + '%';
        }
        refreshOverview();

        const chartAdminActivity = new Chart(document.getElementById('chartAdminActivity'), {
            type: 'line',
            data: {
                labels: Array.from({ length: 12 }, (_, i) => `D${i + 1}`),
                datasets: [
                    { label: 'Provided', data: [2, 3, 2, 5, 4, 6, 3, 5, 4, 6, 5, 5], tension: .35 },
                    { label: 'Received', data: [4, 5, 3, 6, 7, 9, 6, 8, 7, 10, 8, 9], tension: .35 }
                ]
            },
            options: {
                plugins: { legend: { labels: { color: '#cbd5e1' } } },
                scales: {
                    x: { ticks: { color: '#9fb0c9' }, grid: { color: 'rgba(255,255,255,.06)' } },
                    y: { ticks: { color: '#9fb0c9' }, grid: { color: 'rgba(255,255,255,.06)' } }
                }
            }
        });
        new Chart(document.getElementById('chartAdminSplit'), {
            type: 'doughnut',
            data: { labels: ['Medical', 'Education', 'Housing'], datasets: [{ data: [45, 35, 20] }] },
            options: { plugins: { legend: { labels: { color: '#cbd5e1' } } } }
        });

        // ---------- Requests Queue ----------
        function paintQueue() {
            const term = (qSearch.value || '').toLowerCase();
            const filt = qFilter.value || '';
            const reqs = JSON.parse(localStorage.getItem(ALS.REQS) || '[]')
                .filter(r => (!filt || r.status === filt) && (!term || (r.id + r.title).toLowerCase().includes(term)));
            tblQueue.innerHTML = '';
            reqs.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${r.id}</td><td>${r.title}</td><td class="small">${r.member}</td><td>${r.cat}</td><td>${fmt(r.amount)}</td>
          <td><span class="badge ${r.status === 'Verified' ? 'text-bg-info' : r.status === 'Rejected' ? 'text-bg-danger' : 'text-bg-warning'}">${r.status}</span></td>
          <td class="small">${r.created}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light" data-act="verify" data-id="${r.id}" title="Verify"><i class="bi bi-check2"></i></button>
            <button class="btn btn-sm btn-outline-light" data-act="reject" data-id="${r.id}" title="Reject"><i class="bi bi-x"></i></button>
            <button class="btn btn-sm btn-outline-light" data-act="view" data-id="${r.id}" title="View"><i class="bi bi-eye"></i></button>
          </td>`;
                tblQueue.appendChild(tr);
            });
        }
        paintQueue();
        qSearch.addEventListener('input', paintQueue);
        qFilter.addEventListener('change', paintQueue);
        tblQueue.addEventListener('click', e => {
            const b = e.target.closest('button[data-act]'); if (!b) return;
            const id = b.dataset.id; const act = b.dataset.act;
            const arr = JSON.parse(localStorage.getItem(ALS.REQS) || '[]');
            const r = arr.find(x => x.id === id); if (!r) return;
            if (act === 'view') { alert(`${r.id}\n${r.title}\n${r.member} ‚Ä¢ ${r.cat}\n${fmt(r.amount)} ‚Ä¢ ${r.status}`); return; }
            if (act === 'verify') { r.status = 'Verified'; audit('VERIFY_REQUEST', r.id, 'Docs matched'); }
            if (act === 'reject') { r.status = 'Rejected'; audit('REJECT_REQUEST', r.id, 'Insufficient proof'); }
            localStorage.setItem(ALS.REQS, JSON.stringify(arr));
            paintQueue(); refreshOverview();
        });

        // ---------- KYC ----------
        function paintKyc() {
            const term = (kycSearch.value || '').toLowerCase();
            const filt = kycFilter.value || '';
            const list = JSON.parse(localStorage.getItem(ALS.KYC) || '[]')
                .filter(k => (!filt || k.status === filt) && (!term || (k.name + k.email).toLowerCase().includes(term)));
            tblKyc.innerHTML = '';
            list.forEach(k => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${k.name}</td><td class="small">${k.email}</td><td class="small">${k.submitted}</td>
          <td><span class="badge ${k.status === 'Approved' ? 'text-bg-success' : k.status === 'Rejected' ? 'text-bg-danger' : 'text-bg-warning'}">${k.status}</span></td>
          <td class="small">${k.notes || ''}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light" data-act="approve" data-id="${k.id}" title="Approve"><i class="bi bi-check2"></i></button>
            <button class="btn btn-sm btn-outline-light" data-act="reject" data-id="${k.id}" title="Reject"><i class="bi bi-x"></i></button>
          </td>`;
                tblKyc.appendChild(tr);
            });
        }
        paintKyc();
        kycSearch.addEventListener('input', paintKyc);
        kycFilter.addEventListener('change', paintKyc);
        tblKyc.addEventListener('click', e => {
            const b = e.target.closest('button[data-act]'); if (!b) return;
            const id = b.dataset.id; const act = b.dataset.act;
            const list = JSON.parse(localStorage.getItem(ALS.KYC) || '[]');
            const k = list.find(x => x.id === id); if (!k) return;
            if (act === 'approve') { k.status = 'Approved'; k.notes = 'Manual approval'; audit('APPROVE_KYC', k.email, ''); }
            if (act === 'reject') { k.status = 'Rejected'; k.notes = 'Mismatch on ID/selfie'; audit('REJECT_KYC', k.email, ''); }
            localStorage.setItem(ALS.KYC, JSON.stringify(list)); paintKyc(); refreshOverview();
        });

        // ---------- Members ----------
        function paintMembers() {
            const term = (mSearch.value || '').toLowerCase();
            const filt = mFilter.value || '';
            const members = JSON.parse(localStorage.getItem(ALS.MEMBERS) || '[]')
                .filter(m => (!filt || m.status === filt) && (!term || (m.name + m.email).toLowerCase().includes(term)));
            tblMembers.innerHTML = '';
            members.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${m.name}</td><td class="small">${m.email}</td><td class="small">${m.joined}</td>
          <td><span class="badge ${m.status === 'Active' ? 'text-bg-success' : m.status === 'Pending' ? 'text-bg-warning' : 'text-bg-secondary'}">${m.status}</span></td>
          <td class="small">${m.reqs}</td><td class="small">${m.provided}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-light" data-act="toggle" data-id="${m.id}" title="Suspend/Activate"><i class="bi bi-ban"></i></button>
            <button class="btn btn-sm btn-outline-light" data-act="impersonate" data-id="${m.id}" title="Impersonate (demo)"><i class="bi bi-box-arrow-in-right"></i></button>
          </td>`;
                tblMembers.appendChild(tr);
            });
        }
        paintMembers();
        mSearch.addEventListener('input', paintMembers);
        mFilter.addEventListener('change', paintMembers);
        tblMembers.addEventListener('click', e => {
            const b = e.target.closest('button[data-act]'); if (!b) return;
            const id = b.dataset.id; const act = b.dataset.act;
            const members = JSON.parse(localStorage.getItem(ALS.MEMBERS) || '[]');
            const m = members.find(x => x.id === id); if (!m) return;
            if (act === 'toggle') { m.status = m.status === 'Suspended' ? 'Active' : 'Suspended'; audit('TOGGLE_MEMBER', m.email, m.status); }
            if (act === 'impersonate') { alert(`Impersonating ${m.name} (demo)`); audit('IMPERSONATE', m.email, ''); }
            localStorage.setItem(ALS.MEMBERS, JSON.stringify(members)); paintMembers(); refreshOverview();
        });
        btnAddMember.addEventListener('click', () => {
            const members = JSON.parse(localStorage.getItem(ALS.MEMBERS) || '[]');
            const id = uid('U-');
            members.unshift({ id, name: 'New Member', email: `new${Date.now()}@example.com`, joined: new Date().toISOString().slice(0, 10), status: 'Pending', reqs: 0, provided: 0 });
            localStorage.setItem(ALS.MEMBERS, JSON.stringify(members)); paintMembers(); refreshOverview();
        });

        // ---------- Ledger ----------
        function paintLedger() {
            const tx = JSON.parse(localStorage.getItem(ALS.TX) || '[]');
            const term = (txSearch.value || '').toLowerCase();
            const rows = tx.filter(t =>
                !term || t.ref.toLowerCase().includes(term) || t.type.toLowerCase().includes(term) || String(t.member).toLowerCase().includes(term)
            );
            tblTx.innerHTML = '';
            rows.forEach(t => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="small">${t.date}</td><td class="small">${t.type}</td><td class="small">${t.ref}</td><td class="small">${fmt(t.amount)}</td><td class="small">${t.member}</td>
          <td class="small"><span class="badge ${t.status === 'Completed' ? 'text-bg-success' : 'text-bg-warning'}">${t.status}</span></td>`;
                tblTx.appendChild(tr);
            });
            const totProvided = tx.filter(t => t.type === 'Provided').reduce((a, b) => a + b.amount, 0);
            const totReceived = tx.filter(t => t.type === 'Received').reduce((a, b) => a + b.amount, 0);
            sumProvided.textContent = fmt(totProvided);
            sumReceived.textContent = fmt(totReceived);
            sumNet.textContent = fmt(totReceived - totProvided);
        }
        paintLedger();
        txSearch.addEventListener('input', paintLedger);
        new Chart(document.getElementById('chartLedger'), {
            type: 'bar',
            data: { labels: ['W1', 'W2', 'W3', 'W4'], datasets: [{ label: 'Net', data: [2, 4, 3, 5] }] },
            options: { plugins: { legend: { labels: { color: '#cbd5e1' } } }, scales: { x: { ticks: { color: '#9fb0c9' } }, y: { ticks: { color: '#9fb0c9' } } } }
        });
        document.getElementById('btnExportTx').addEventListener('click', () => {
            const tx = JSON.parse(localStorage.getItem(ALS.TX) || '[]');
            exportCsv('transactions.csv', ['Date', 'Type', 'Ref', 'Amount', 'Member', 'Status'],
                tx.map(t => [t.date, t.type, t.ref, t.amount, t.member, t.status]));
        });

        // ---------- Tickets ----------
        function paintTickets() {
            const list = JSON.parse(localStorage.getItem(ALS.TICKETS) || '[]');
            tktList.innerHTML = '';
            list.forEach(c => {
                const a = document.createElement('a');
                a.href = '#'; a.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                a.dataset.tid = c.id;
                a.innerHTML = `<span><i class="bi bi-chat-left-text me-2"></i>${c.title} <span class="muted small">‚Ä¢ ${c.from}</span></span><span class="small muted">${c.last}</span>`;
                tktList.appendChild(a);
            });
        }
        function openTicket(tid) {
            const list = JSON.parse(localStorage.getItem(ALS.TICKETS) || '[]'); const c = list.find(x => x.id === tid); if (!c) return;
            tktTitle.textContent = c.title; tktMeta.textContent = c.from + ' ‚Ä¢ ' + c.last;
            const thread = document.getElementById('tktThread'); thread.innerHTML = ''; thread.dataset.tid = tid;
            c.thread.forEach(m => {
                const row = document.createElement('div'); row.className = 'd-flex ' + (m.me ? 'justify-content-end' : 'justify-content-start');
                row.innerHTML = `<div class="p-2 rounded-3 ${m.me ? 'bg-primary text-dark' : 'bg-dark text-light'}" style="max-width:70%">${m.text}<div class="small muted mt-1">${m.at}</div></div>`;
                thread.appendChild(row);
            });
            thread.scrollTop = thread.scrollHeight;
        }
        paintTickets();
        tktList.addEventListener('click', e => {
            const a = e.target.closest('a[data-tid]'); if (!a) return; e.preventDefault(); openTicket(a.dataset.tid);
        });
        document.getElementById('btnNewTicket').addEventListener('click', () => {
            const list = JSON.parse(localStorage.getItem(ALS.TICKETS) || '[]');
            const id = uid('T-'); list.unshift({ id, title: 'New ticket', from: 'System', last: new Date().toISOString().slice(0, 10), thread: [] });
            localStorage.setItem(ALS.TICKETS, JSON.stringify(list)); paintTickets(); openTicket(id);
        });
        document.getElementById('formReply').addEventListener('submit', (e) => {
            e.preventDefault();
            const tid = tktThread.dataset.tid; if (!tid) return;
            const txt = tktInput.value.trim(); if (!txt) return;
            const list = JSON.parse(localStorage.getItem(ALS.TICKETS) || '[]'); const c = list.find(x => x.id === tid);
            c.thread.push({ me: true, text: txt, at: nowISO() }); c.last = new Date().toISOString().slice(0, 10);
            localStorage.setItem(ALS.TICKETS, JSON.stringify(list));
            tktInput.value = '';
            openTicket(tid);
            paintTickets();
            audit('REPLY_TICKET', tid, txt.slice(0, 60));
        });

        // ---------- Policies CMS ----------
        (function loadCms() {
            const cms = JSON.parse(localStorage.getItem(ALS.CMS) || '{}');
            cmsAbout.value = cms.about || '';
            cmsRisk.value = cms.risk || '';
            cmsFaq.value = cms.faq || '';
        })();
        formCms.addEventListener('submit', (e) => {
            e.preventDefault();
            const obj = { about: cmsAbout.value, risk: cmsRisk.value, faq: cmsFaq.value };
            localStorage.setItem(ALS.CMS, JSON.stringify(obj));
            audit('SAVE_CMS', 'Policies', '');
            alert('Saved (demo).');
        });
        document.getElementById('btnPreviewPolicy').addEventListener('click', () => {
            const cms = JSON.parse(localStorage.getItem(ALS.CMS) || '{}');
            alert(`ABOUT:\n${cms.about}\n\nRISKS:\n${cms.risk}\n\nFAQ:\n${cms.faq}`);
        });

        // ---------- Settings / Roles ----------
        function paintRoles() {
            const roles = JSON.parse(localStorage.getItem(ALS.ROLES) || '[]');
            tblRoles.innerHTML = '';
            roles.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="small">${r.user}</td><td class="small">${r.role}</td>
          <td class="text-end"><button class="btn btn-sm btn-outline-light" data-user="${r.user}" data-act="cycle"><i class="bi bi-arrow-repeat"></i></button></td>`;
                tblRoles.appendChild(tr);
            });
            const sa = roles.find(x => x.role === 'Super Admin');
            adminNameTop.textContent = sa ? sa.user.split('@')[0] : 'Administrator';
            roleBadge.textContent = 'Role: ' + (sa ? 'Super Admin' : (roles[0]?.role || 'Admin'));
        }
        paintRoles();
        document.getElementById('tblRoles').addEventListener('click', e => {
            const b = e.target.closest('button[data-user]'); if (!b) return;
            const user = b.dataset.user;
            const roles = JSON.parse(localStorage.getItem(ALS.ROLES) || '[]');
            const r = roles.find(x => x.user === user); if (!r) return;
            r.role = r.role === 'Support' ? 'Reviewer' : r.role === 'Reviewer' ? 'Super Admin' : 'Support';
            localStorage.setItem(ALS.ROLES, JSON.stringify(roles));
            paintRoles();
            audit('CHANGE_ROLE', user, r.role);
        });
        formPrefs.addEventListener('submit', (e) => {
            e.preventDefault(); audit('SAVE_PREFS', 'Admin', ''); alert('Preferences saved (demo).');
        });

        // ---------- Audit ----------
        function paintAudit() {
            const arr = JSON.parse(localStorage.getItem(ALS.AUDIT) || '[]');
            tblAudit.innerHTML = '';
            arr.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="small">${a.at}</td><td class="small">${a.admin}</td><td class="small">${a.action}</td><td class="small">${a.target}</td><td class="small">${a.notes || ''}</td>`;
                tblAudit.appendChild(tr);
            });
        }
        paintAudit();
        document.getElementById('btnExportAudit').addEventListener('click', () => {
            const a = JSON.parse(localStorage.getItem(ALS.AUDIT) || '[]');
            exportCsv('audit.csv', ['When', 'Admin', 'Action', 'Target', 'Notes'], a.map(x => [x.at, x.admin, x.action, x.target, x.notes]));
        });

        // ---------- Broadcast ----------
        formBroadcast.addEventListener('submit', (e) => {
            e.preventDefault();
            audit('BROADCAST', bcAudience.value, bcMsg.value.slice(0, 80));
            alert('Broadcast queued (demo).');
            bootstrap.Modal.getInstance(document.getElementById('modalBroadcast'))?.hide();
            e.target.reset();
        });

        // ---------- Hash tabs + Mobile close ----------
        if (location.hash) {
            const trigger = document.querySelector(`[data-bs-target="${location.hash}"]`);
            if (trigger) new bootstrap.Tab(trigger).show();
        }
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(el => {
            el.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('data-bs-target');
                if (target) history.replaceState(null, '', target);
                sidebar?.classList.remove('open');
            });
        });

        // ---------- Export All (one-click) ----------
        document.getElementById('btnExportAll').addEventListener('click', () => {
            const tx = JSON.parse(localStorage.getItem(ALS.TX) || '[]');
            const reqs = JSON.parse(localStorage.getItem(ALS.REQS) || '[]');
            const kyc = JSON.parse(localStorage.getItem(ALS.KYC) || '[]');
            const aud = JSON.parse(localStorage.getItem(ALS.AUDIT) || '[]');
            exportCsv('transactions.csv', ['Date', 'Type', 'Ref', 'Amount', 'Member', 'Status'], tx.map(t => [t.date, t.type, t.ref, t.amount, t.member, t.status]));
            exportCsv('requests.csv', ['Ref', 'Title', 'Member', 'Category', 'Amount', 'Status', 'Created'], reqs.map(r => [r.id, r.title, r.member, r.cat, r.amount, r.status, r.created]));
            exportCsv('kyc.csv', ['ID', 'Name', 'Email', 'Submitted', 'Status', 'Notes'], kyc.map(k => [k.id, k.name, k.email, k.submitted, k.status, k.notes || '']));
            exportCsv('audit.csv', ['When', 'Admin', 'Action', 'Target', 'Notes'], aud.map(x => [x.at, x.admin, x.action, x.target, x.notes || '']));
        });
    </script>
</body>

</html>